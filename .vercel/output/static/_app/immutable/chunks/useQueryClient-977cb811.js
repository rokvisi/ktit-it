import{S as w,h as D,n as x,u as I,i as E,t as M,k as j,r as C,b as T,v as k,a as L,c as _}from"./logger-312c5320.js";import{P as q}from"./index-055277d2.js";class z extends w{constructor(e,t){super(),this.client=e,this.options=t,this.trackedProps=[],this.previousSelectError=null,this.bindMethods(),this.setOptions(t)}bindMethods(){this.remove=this.remove.bind(this),this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.length===1&&(this.currentQuery.addObserver(this),F(this.currentQuery,this.options)&&this.executeFetch(),this.updateTimers())}onUnsubscribe(){this.listeners.length||this.destroy()}shouldFetchOnReconnect(){return N(this.currentQuery,this.options)}shouldFetchOnWindowFocus(){return B(this.currentQuery,this.options)}destroy(){this.listeners=[],this.clearTimers(),this.currentQuery.removeObserver(this)}setOptions(e,t){const r=this.options,u=this.currentQuery;if(this.options=this.client.defaultQueryObserverOptions(e),typeof this.options.enabled<"u"&&typeof this.options.enabled!="boolean")throw new Error("Expected enabled to be a boolean");this.options.queryKey||(this.options.queryKey=r.queryKey),this.updateQuery();const s=this.hasListeners();s&&P(this.currentQuery,u,this.options,r)&&this.executeFetch(),this.updateResult(t),s&&(this.currentQuery!==u||this.options.enabled!==r.enabled||this.options.staleTime!==r.staleTime)&&this.updateStaleTimeout();const n=this.computeRefetchInterval();s&&(this.currentQuery!==u||this.options.enabled!==r.enabled||n!==this.currentRefetchInterval)&&this.updateRefetchInterval(n)}updateOptions(e,t){const r=Object.assign(Object.assign({},this.options),e);e.queryKey&&!e.queryHash&&e.queryKey!==this.options.queryKey&&(r.queryHash=D(e.queryKey,r)),this.setOptions(r,t)}getOptimisticResult(e){const t=this.client.defaultQueryObserverOptions(e),r=this.client.getQueryCache().build(this.client,t);return this.createResult(r,t)}getCurrentResult(){return this.currentResult}trackResult(e,t){const r={},u=s=>{this.trackedProps.includes(s)||this.trackedProps.push(s)};return Object.keys(e).forEach(s=>{Object.defineProperty(r,s,{configurable:!1,enumerable:!0,get:()=>(u(s),e[s])})}),(t.useErrorBoundary||t.suspense)&&u("error"),r}getNextResult(e){return new Promise((t,r)=>{const u=this.subscribe(s=>{s.isFetching||(u(),s.isError&&(e==null?void 0:e.throwOnError)?r(s.error):t(s))})})}getCurrentQuery(){return this.currentQuery}remove(){this.client.getQueryCache().remove(this.currentQuery)}refetch(e){return this.fetch(Object.assign(Object.assign({},e),{meta:{refetchPage:e==null?void 0:e.refetchPage}}))}fetchOptimistic(e){const t=this.client.defaultQueryObserverOptions(e),r=this.client.getQueryCache().build(this.client,t);return r.fetch().then(()=>this.createResult(r,t))}fetch(e){return this.executeFetch(e).then(()=>(this.updateResult(),this.currentResult))}executeFetch(e){this.updateQuery();let t=this.currentQuery.fetch(this.options,e);return e!=null&&e.throwOnError||(t=t.catch(x)),t}updateStaleTimeout(){if(this.clearStaleTimeout(),I||this.currentResult.isStale||!E(this.options.staleTime))return;const t=M(this.currentResult.dataUpdatedAt,this.options.staleTime)+1;this.staleTimeoutId=setTimeout(()=>{this.currentResult.isStale||this.updateResult()},t)}computeRefetchInterval(){var e;return typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.currentResult.data,this.currentQuery):(e=this.options.refetchInterval)!==null&&e!==void 0?e:!1}updateRefetchInterval(e){this.clearRefetchInterval(),this.currentRefetchInterval=e,!(I||this.options.enabled===!1||!E(this.currentRefetchInterval)||this.currentRefetchInterval===0)&&(this.refetchIntervalId=setInterval(()=>{(this.options.refetchIntervalInBackground||j.isFocused())&&this.executeFetch()},this.currentRefetchInterval))}updateTimers(){this.updateStaleTimeout(),this.updateRefetchInterval(this.computeRefetchInterval())}clearTimers(){this.clearStaleTimeout(),this.clearRefetchInterval()}clearStaleTimeout(){clearTimeout(this.staleTimeoutId),this.staleTimeoutId=void 0}clearRefetchInterval(){clearInterval(this.refetchIntervalId),this.refetchIntervalId=void 0}createResult(e,t){var r;const u=this.currentQuery,s=this.options,n=this.currentResult,o=this.currentResultState,f=this.currentResultOptions,p=e!==u,v=p?e.state:this.currentQueryInitialState,h=p?this.currentResult:this.previousQueryResult,{state:c}=e;let{dataUpdatedAt:b,error:m,errorUpdatedAt:O,isFetching:Q,status:a}=c,g=!1,S=!1,d;if(t.optimisticResults){const l=this.hasListeners(),y=!l&&F(e,t),U=l&&P(e,u,t,s);(y||U)&&(Q=!0,b||(a="loading"))}if(t.keepPreviousData&&!c.dataUpdateCount&&(h==null?void 0:h.isSuccess)&&a!=="error")d=h.data,b=h.dataUpdatedAt,a=h.status,g=!0;else if(t.select&&typeof c.data<"u")if(n&&c.data===(o==null?void 0:o.data)&&t.select===((r=this.previousSelect)===null||r===void 0?void 0:r.fn)&&!this.previousSelectError)d=this.previousSelect.result;else try{d=t.select(c.data),t.structuralSharing!==!1&&(d=C(n==null?void 0:n.data,d)),this.previousSelect={fn:t.select,result:d},this.previousSelectError=null}catch(l){T().error(l),m=l,this.previousSelectError=l,O=Date.now(),a="error"}else d=c.data;if(typeof t.placeholderData<"u"&&typeof d>"u"&&(a==="loading"||a==="idle")){let l;if((n==null?void 0:n.isPlaceholderData)&&t.placeholderData===(f==null?void 0:f.placeholderData))l=n.data;else if(l=typeof t.placeholderData=="function"?t.placeholderData():t.placeholderData,t.select&&typeof l<"u")try{l=t.select(l),t.structuralSharing!==!1&&(l=C(n==null?void 0:n.data,l)),this.previousSelectError=null}catch(y){T().error(y),m=y,this.previousSelectError=y,O=Date.now(),a="error"}typeof l<"u"&&(a="success",d=l,S=!0)}return{status:a,isLoading:a==="loading",isSuccess:a==="success",isError:a==="error",isIdle:a==="idle",data:d,dataUpdatedAt:b,error:m,errorUpdatedAt:O,failureCount:c.fetchFailureCount,isFetched:c.dataUpdateCount>0||c.errorUpdateCount>0,isFetchedAfterMount:c.dataUpdateCount>v.dataUpdateCount||c.errorUpdateCount>v.errorUpdateCount,isFetching:Q,isRefetching:Q&&a!=="loading",isLoadingError:a==="error"&&c.dataUpdatedAt===0,isPlaceholderData:S,isPreviousData:g,isRefetchError:a==="error"&&c.dataUpdatedAt!==0,isStale:R(e,t),refetch:this.refetch,remove:this.remove}}shouldNotifyListeners(e,t){if(!t)return!0;const{notifyOnChangeProps:r,notifyOnChangePropsExclusions:u}=this.options;if(!r&&!u||r==="tracked"&&!this.trackedProps.length)return!0;const s=r==="tracked"?this.trackedProps:r;return Object.keys(e).some(n=>{const o=n,f=e[o]!==t[o],p=s==null?void 0:s.some(h=>h===n),v=u==null?void 0:u.some(h=>h===n);return f&&!v&&(!s||p)})}updateResult(e){const t=this.currentResult;if(this.currentResult=this.createResult(this.currentQuery,this.options),this.currentResultState=this.currentQuery.state,this.currentResultOptions=this.options,k(this.currentResult,t))return;const r={cache:!0};(e==null?void 0:e.listeners)!==!1&&this.shouldNotifyListeners(this.currentResult,t)&&(r.listeners=!0),this.notify(Object.assign(Object.assign({},r),e))}updateQuery(){const e=this.client.getQueryCache().build(this.client,this.options);if(e===this.currentQuery)return;const t=this.currentQuery;this.currentQuery=e,this.currentQueryInitialState=e.state,this.previousQueryResult=this.currentResult,this.hasListeners()&&(t==null||t.removeObserver(this),e.addObserver(this))}onQueryUpdate(e){const t={};e.type==="success"?t.onSuccess=!0:e.type==="error"&&!L(e.error)&&(t.onError=!0),this.updateResult(t),this.hasListeners()&&this.updateTimers()}notify(e){_.batch(()=>{var t,r,u,s,n,o,f,p;e.onSuccess?((r=(t=this.options).onSuccess)===null||r===void 0||r.call(t,this.currentResult.data),(s=(u=this.options).onSettled)===null||s===void 0||s.call(u,this.currentResult.data,null)):e.onError&&((o=(n=this.options).onError)===null||o===void 0||o.call(n,this.currentResult.error),(p=(f=this.options).onSettled)===null||p===void 0||p.call(f,void 0,this.currentResult.error)),e.listeners&&this.listeners.forEach(v=>{v(this.currentResult)}),e.cache&&this.client.getQueryCache().notify({query:this.currentQuery,type:"observerResultsUpdated"})})}}function A(i,e){return e.enabled!==!1&&!i.state.dataUpdatedAt&&!(i.state.status==="error"&&e.retryOnMount===!1)}function K(i,e){return e.enabled!==!1&&i.state.dataUpdatedAt>0&&(e.refetchOnMount==="always"||e.refetchOnMount!==!1&&R(i,e))}function F(i,e){return A(i,e)||K(i,e)}function N(i,e){return e.enabled!==!1&&(e.refetchOnReconnect==="always"||e.refetchOnReconnect!==!1&&R(i,e))}function B(i,e){return e.enabled!==!1&&(e.refetchOnWindowFocus==="always"||e.refetchOnWindowFocus!==!1&&R(i,e))}function P(i,e,t,r){return t.enabled!==!1&&(i!==e||r.enabled===!1)&&(!t.suspense||i.state.status!=="error")&&R(i,t)}function R(i,e){return i.isStaleByTime(e.staleTime)}function G(){const i=q("queryClient");if(!i)throw new Error("No QueryClient set, use QueryClientProvider to set one");return i}export{z as Q,G as u};
